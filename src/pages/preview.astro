---
import { type BirthdayData } from "../resources/types/form-step";
import { decrypt } from "../resources/utils/crypto";
import BirthDayCard from "../components/BirthDayCard.astro";
import MainLayout from "../layouts/MainLayout.astro";
import { format } from "date-fns";
import { supabase } from "../lib/supabase";
import { slugify } from "../resources/utils/slugify";

const token = Astro.url.searchParams.get("token")! || "";

const decryptData = token ? decrypt(token, import.meta.env.SECRET_KEY) : "";
const data = decryptData ? JSON.parse(decryptData) : {};

// Automatic Migration Logic
if (token && data && data.names) {
  try {
    // 1. Check if this card already exists in Supabase
    // We use the data object (excluding any potentially new fields) to check containment
    const cleanData = { ...data };
    delete cleanData.slug; // Ensure we don't look for slug in data if it wasn't there

    const { data: existing } = await supabase
      .from("cards")
      .select("slug")
      .contains("data", cleanData)
      .limit(1)
      .maybeSingle();

    if (existing) {
      // Card exists, redirect to it
      return Astro.redirect(`/card/${existing.slug}`);
    } else {
      // Card doesn't exist, create it
      const year = new Date().getFullYear();
      const baseSlug = `${slugify(data.names)}-${year}`;
      let finalSlug = baseSlug;

      // Attempt insert
      // We first try the base slug. If it fails (constraint), we try with random suffix.

      // Note: To handle unique constraint race-conditions purely one-shot is hard without retry.
      // We'll simplistic check or just try/catch insert.
      // Let's Check if slug exists to avoid error log noise.
      const { data: slugCheck } = await supabase
        .from("cards")
        .select("id")
        .eq("slug", finalSlug)
        .maybeSingle();

      if (slugCheck) {
        finalSlug = `${baseSlug}-${Math.random().toString(36).substring(2, 6)}`;
      }

      // Add slug to data and insert
      data.slug = finalSlug;

      const { error } = await supabase.from("cards").insert({
        slug: finalSlug,
        data: data,
      });

      if (!error) {
        return Astro.redirect(`/card/${finalSlug}`);
      } else {
        console.error("Migration Error (Insert):", error);
      }
    }
  } catch (error) {
    console.error("Migration Error:", error);
    // Proceed to render preview normally as fallback
  }
}

console.log("Data of preview", data);

const {
  color,
  birthday,
  message,
  names,
  url,
  secretMessage,
  premessage,
  ...rest
}: BirthdayData = data;

const { bgColor, textColor, viaColor } = color ?? {};

const birthDate = new Date(`${birthday} 00:00:00`);
const current = new Date();

// Check if today is the birthday
const isMonth = current.getMonth() === birthDate.getMonth();
const isDay = current.getDate() === birthDate.getDate();
const isBirthdayDay = isMonth && isDay;

// Calculate target date for countdown (next birthday)
let targetDate = new Date(
  current.getFullYear(),
  birthDate.getMonth(),
  birthDate.getDate(),
);

if (!isBirthdayDay && targetDate.getTime() < current.getTime()) {
  targetDate.setFullYear(current.getFullYear() + 1);
}

const date = format(targetDate, "yyyy-MM-dd");

// SEO / OG Logic
const pageTitle = isBirthdayDay
  ? `Â¡Feliz CumpleaÃ±os ${names}! ðŸŽ‰`
  : `Cuenta regresiva para ${names} â³`;

const pageDescription = isBirthdayDay
  ? secretMessage
    ? "ðŸŽ Â¡Hay un mensaje secreto y una sorpresa esperando por ti! Entra para descubrirlo."
    : (message?.substring(0, 160) ?? "Â¡Te han enviado una tarjeta especial!")
  : (premessage ?? `Faltan dÃ­as para celebrar a ${names}. Â¡Mira esta tarjeta!`);

const pageImage = url || "/cumple-logo-icon.png";
---

<MainLayout
  color={bgColor}
  title={pageTitle}
  description={pageDescription}
  image={pageImage}
>
  <BirthDayCard
    color={viaColor}
    name={names}
    message={message}
    isBirthdayDay={isBirthdayDay}
    date={date}
    textColor={textColor}
    url={url}
    secretMessage={secretMessage}
    premessage={premessage}
    {...rest}
  />
  <!-- <div class="fixed top-4 right-4 z-60">
    <a
      href={`/edit/${encodeURIComponent(token)}`}
      class="bg-white/80 backdrop-blur-sm border border-pink-200 text-pink-600 px-4 py-2 rounded-full shadow-lg hover:scale-105 transition-transform flex items-center gap-2 font-medium"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path>
        <path d="m15 5 4 4"></path>
      </svg>
      Editar
    </a>
  </div> -->
</MainLayout>
