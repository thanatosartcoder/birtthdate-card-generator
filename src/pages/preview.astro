---
import { type BirthdayData } from "../resources/types/form-step";
import { decrypt } from "../resources/utils/crypto";
import BirthDayCard from "../components/BirthDayCard.astro";
import MainLayout from "../layouts/MainLayout.astro";
import { format } from "date-fns";

const token = Astro.url.searchParams.get("token")! || "";

const decryptData = token ? decrypt(token, import.meta.env.SECRET_KEY) : "";

const data = decryptData ? JSON.parse(decryptData) : {};

console.log("Data of preview", data);

const { color, birthday, message, names, url, ...rest }: BirthdayData = data;

const { bgColor, textColor, viaColor } = color ?? {};

const birthDate = new Date(`${birthday} 00:00:00`);
const current = new Date();

// Check if today is the birthday
const isMonth = current.getMonth() === birthDate.getMonth();
const isDay = current.getDate() === birthDate.getDate();
const isBirthdayDay = isMonth && isDay;

// Calculate target date for countdown (next birthday)
let targetDate = new Date(
  current.getFullYear(),
  birthDate.getMonth(),
  birthDate.getDate()
);

if (!isBirthdayDay && targetDate.getTime() < current.getTime()) {
  targetDate.setFullYear(current.getFullYear() + 1);
}

const date = format(targetDate, "yyyy-MM-dd");
---

<MainLayout
  color={bgColor}
  title={`CumpleaÃ±os de ${names}`}
  description={message}
  image={url}
>
  <BirthDayCard
    color={viaColor}
    name={names}
    message={message}
    isBirthdayDay={isBirthdayDay}
    date={date}
    textColor={textColor}
    url={url}
    {...rest}
  />
</MainLayout>
